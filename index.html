<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>JDP SUPREME - KERNEL v27.0</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-blue: #00f2ff;
            --neon-gold: #bf953f;
            --deep-black: #020202;
            --glass: rgba(10, 10, 10, 0.98);
            --my-bubble: linear-gradient(135deg, #004e52 0%, #002a2d 100%);
            --their-bubble: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body, html { margin: 0; padding: 0; height: 100dvh; background: var(--deep-black); color: #e0e0e0; font-family: 'Rajdhani', sans-serif; overflow: hidden; }

        /* BOOT SCREEN */
        #boot-screen { position: fixed; inset: 0; background: black; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 4px solid var(--neon-gold); }
        .logo-jdp { font-family: 'Orbitron'; font-size: 2rem; color: var(--neon-gold); margin-bottom: 30px; text-shadow: 0 0 15px var(--neon-gold); }
        .btn-start { background: none; border: 2px solid var(--neon-blue); color: var(--neon-blue); padding: 20px; font-family: 'Orbitron'; cursor: pointer; margin: 10px; width: 280px; font-weight: bold; transition: 0.3s; }
        .btn-start:active { background: var(--neon-blue); color: black; }

        /* HEADER */
        header { height: 80px; background: var(--glass); border-bottom: 2px solid var(--neon-gold); display: flex; align-items: center; padding: 0 15px; gap: 12px; z-index: 100; }
        .profile-square { width: 55px; height: 55px; border: 2px solid var(--neon-gold); background: #111; display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0; }
        .profile-square img { width: 100%; height: 100%; object-fit: cover; }
        .header-info { flex: 1; }
        .header-info h4 { margin: 0; font-family: 'Orbitron'; font-size: 0.9rem; color: var(--neon-gold); }
        #p-status { font-size: 0.7rem; color: #555; font-weight: bold; text-transform: uppercase; }

        /* CALL SYSTEM - REPARADO */
        #call-overlay { position: fixed; inset: 0; background: #000; z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; background: #000; }
        #local-video { width: 100px; height: 140px; position: absolute; top: 30px; right: 20px; border: 2px solid var(--neon-gold); z-index: 11; background: #000; object-fit: cover; }
        .call-ui { position: absolute; bottom: 60px; display: flex; gap: 40px; z-index: 12; }
        .c-btn { width: 75px; height: 75px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.5rem; }
        .c-hangup { background: #ff0033; box-shadow: 0 0 20px #ff0033; }
        .c-accept { background: #00ff66; box-shadow: 0 0 20px #00ff66; }

        /* CHAT */
        #chat-flow { flex: 1; overflow-y: auto; padding: 20px 15px; display: flex; flex-direction: column; gap: 15px; background: radial-gradient(circle, #0a0a0a 10%, transparent 11%); background-size: 20px 20px; }
        .msg-row { display: flex; width: 100%; flex-direction: column; }
        .msg-row.me { align-items: flex-end; }
        .msg-row.them { align-items: flex-start; }
        .bubble { max-width: 85%; padding: 12px; border-radius: 2px; position: relative; font-size: 1.1rem; border: 1px solid rgba(255,255,255,0.05); word-wrap: break-word; }
        .me .bubble { background: var(--my-bubble); border-right: 4px solid var(--neon-blue); }
        .them .bubble { background: var(--their-bubble); border-left: 4px solid var(--neon-gold); }

        /* COMMAND BAR */
        .command-bar { padding: 10px 15px 35px; background: var(--glass); display: flex; align-items: center; gap: 10px; border-top: 1px solid #222; }
        .input-field { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid #333; padding: 15px; color: white; font-family: 'Rajdhani'; font-size: 1.1rem; }
        .action-btn { width: 55px; height: 55px; background: var(--neon-gold); border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        
        .menu-drop { position: absolute; top: 70px; right: 15px; background: var(--glass); border: 1px solid var(--neon-gold); display: none; flex-direction: column; z-index: 1000; }
        .menu-drop button { background: none; border: none; color: white; padding: 15px 25px; text-align: left; font-family: 'Rajdhani'; border-bottom: 1px solid #222; }
    </style>
</head>
<body>

    <div id="boot-screen">
        <div class="logo-jdp">JDP INDUSTRIAL</div>
        <button class="btn-start" onclick="initKernel('JDP-JOSE')">OPERADOR: JOS√â</button>
        <button class="btn-start" onclick="initKernel('JDP-ESPOSA')">OPERADOR: ESPOSA</button>
    </div>

    <div id="call-overlay">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay playsinline muted></video>
        <div id="call-status" style="position:absolute; top:100px; font-family:'Orbitron'; color:var(--neon-gold); text-align:center;">CONECTANDO...</div>
        <div class="call-ui">
            <button class="c-btn c-hangup" onclick="endCall()">‚ùå</button>
            <button id="btn-accept" class="c-btn c-accept" onclick="answerCall()">‚úÖ</button>
        </div>
    </div>

    <div style="display: flex; flex-direction: column; height: 100dvh;">
        <header>
            <div class="profile-square">
                <img id="p-img" src="" style="display:none">
                <span id="p-initial" style="font-family:'Orbitron'; font-weight:bold; color:var(--neon-gold);">JDP</span>
            </div>
            <div class="header-info">
                <h4 id="p-name">SISTEMA JDP</h4>
                <span id="p-status">OFFLINE</span>
            </div>
            <button class="action-btn" style="background:none; color:var(--neon-gold);" onclick="makeCall(false)">üìû</button>
            <button class="action-btn" style="background:none; color:var(--neon-gold);" onclick="makeCall(true)">üìπ</button>
            <button class="action-btn" style="background:none; color:var(--neon-gold);" onclick="toggleMenu()">‚ãÆ</button>
            <div class="menu-drop" id="main-menu">
                <button onclick="triggerFile('bg-input')">Mudar Fundo</button>
                <button onclick="triggerFile('profile-input')">Mudar Foto</button>
                <button onclick="clearHistory()" style="color:#ff4444">Limpar Tudo</button>
            </div>
        </header>

        <input type="file" id="bg-input" hidden accept="image/*" onchange="updateBg(this)">
        <input type="file" id="profile-input" hidden accept="image/*" onchange="updateProfile(this)">
        <input type="file" id="media-input" hidden accept="image/*,video/*" onchange="sendMedia(this)">

        <div id="chat-flow"></div>

        <div class="command-bar">
            <button class="action-btn" style="background:none; color:var(--neon-gold);" onclick="document.getElementById('media-input').click()">üìé</button>
            <input type="text" id="main-input" class="input-field" placeholder="Escrever..." oninput="uiState()">
            <button id="master-btn" class="action-btn" onclick="handleAction()">
                <span id="ico-mic">üé§</span>
                <span id="ico-send" style="display:none">‚û§</span>
            </button>
        </div>
    </div>

    <script>
        let peer, conn, myID, partnerID, localStream, activeCall;
        let db = JSON.parse(localStorage.getItem('jdp_v27_db') || '[]');

        function initKernel(id) {
            myID = id;
            partnerID = (id === 'JDP-JOSE') ? 'JDP-ESPOSA' : 'JDP-JOSE';
            document.getElementById('boot-screen').style.display = 'none';
            document.getElementById('p-name').innerText = partnerID.replace('JDP-', '');
            
            peer = new Peer(myID, {
                config: {'iceServers': [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' }]}
            });

            peer.on('open', () => { loadHistory(); autoConnect(); });
            peer.on('connection', c => { conn = c; bindEvents(); });
            
            // RECEBER CHAMADA
            peer.on('call', call => {
                activeCall = call;
                document.getElementById('call-overlay').style.display = 'flex';
                document.getElementById('btn-accept').style.display = 'flex';
                document.getElementById('call-status').innerText = "CHAMADA RECEBIDA";
            });

            if(localStorage.getItem('jdp_bg')) document.getElementById('chat-flow').style.backgroundImage = `url(${localStorage.getItem('jdp_bg')})`;
            if(localStorage.getItem('jdp_pic')) {
                document.getElementById('p-img').src = localStorage.getItem('jdp_pic');
                document.getElementById('p-img').style.display = 'block';
                document.getElementById('p-initial').style.display = 'none';
            }
        }

        function autoConnect() {
            conn = peer.connect(partnerID, { reliable: true });
            bindEvents();
            setTimeout(() => { if(!conn || !conn.open) autoConnect(); }, 5000);
        }

        function bindEvents() {
            conn.on('open', () => {
                document.getElementById('p-status').innerText = "ONLINE";
                document.getElementById('p-status').style.color = "var(--neon-blue)";
            });
            conn.on('data', data => pushMsg(data, false));
            conn.on('close', () => {
                document.getElementById('p-status').innerText = "OFFLINE";
                document.getElementById('p-status').style.color = "#555";
            });
        }

        // --- SISTEMA DE CHAMADA REPARADO ---
        async function makeCall(videoMode) {
            try {
                document.getElementById('call-overlay').style.display = 'flex';
                document.getElementById('btn-accept').style.display = 'none';
                document.getElementById('call-status').innerText = "CHAMANDO...";

                localStream = await navigator.mediaDevices.getUserMedia({ video: videoMode, audio: true });
                document.getElementById('local-video').srcObject = localStream;

                activeCall = peer.call(partnerID, localStream);
                
                activeCall.on('stream', remoteStream => {
                    const remoteVideo = document.getElementById('remote-video');
                    remoteVideo.srcObject = remoteStream;
                    remoteVideo.play();
                    document.getElementById('call-status').innerText = "EM CONEX√ÉO";
                });

                activeCall.on('close', endCall);
            } catch (err) {
                alert("Erro ao acessar c√¢mera/microfone");
                endCall();
            }
        }

        async function answerCall() {
            try {
                document.getElementById('btn-accept').style.display = 'none';
                document.getElementById('call-status').innerText = "CONECTANDO...";

                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('local-video').srcObject = localStream;

                activeCall.answer(localStream);
                
                activeCall.on('stream', remoteStream => {
                    const remoteVideo = document.getElementById('remote-video');
                    remoteVideo.srcObject = remoteStream;
                    remoteVideo.play();
                    document.getElementById('call-status').innerText = "EM CONEX√ÉO";
                });
            } catch (err) {
                alert("Erro ao atender chamada");
                endCall();
            }
        }

        function endCall() {
            if(activeCall) activeCall.close();
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            document.getElementById('call-overlay').style.display = 'none';
            document.getElementById('remote-video').srcObject = null;
        }

        // --- RESTANTE DAS FUN√á√ïES ---
        function handleAction() {
            const input = document.getElementById('main-input');
            if(input.value.trim()) {
                pushMsg({ type: 'text', val: input.value }, true);
                input.value = '';
                uiState();
            }
        }

        function pushMsg(data, isMine) {
            const payload = { ...data, sender: isMine ? myID : partnerID, time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) };
            db.push(payload);
            localStorage.setItem('jdp_v27_db', JSON.stringify(db.slice(-50)));
            render(payload);
            if(isMine && conn && conn.open) conn.send(payload);
        }

        function render(msg) {
            const flow = document.getElementById('chat-flow');
            const side = msg.sender === myID ? 'me' : 'them';
            let html = msg.val;
            if(msg.type === 'img') html = `<img src="${msg.val}" style="max-width:100%; border:1px solid var(--neon-gold);">`;
            flow.insertAdjacentHTML('beforeend', `<div class="msg-row ${side}"><div class="bubble">${html}<div style="font-size:0.6rem; opacity:0.4; text-align:right;">${msg.time}</div></div></div>`);
            flow.scrollTop = flow.scrollHeight;
        }

        function uiState() {
            const hasText = document.getElementById('main-input').value.length > 0;
            document.getElementById('ico-mic').style.display = hasText ? 'none' : 'block';
            document.getElementById('ico-send').style.display = hasText ? 'block' : 'none';
        }

        function toggleMenu() { const m = document.getElementById('main-menu'); m.style.display = m.style.display === 'flex' ? 'none' : 'flex'; }
        function triggerFile(id) { document.getElementById(id).click(); toggleMenu(); }
        function updateBg(input) { const reader = new FileReader(); reader.onload = (e) => { document.getElementById('chat-flow').style.backgroundImage = `url(${e.target.result})`; localStorage.setItem('jdp_bg', e.target.result); }; reader.readAsDataURL(input.files[0]); }
        function updateProfile(input) { const reader = new FileReader(); reader.onload = (e) => { document.getElementById('p-img').src = e.target.result; document.getElementById('p-img').style.display = 'block'; document.getElementById('p-initial').style.display = 'none'; localStorage.setItem('jdp_pic', e.target.result); }; reader.readAsDataURL(input.files[0]); }
        function loadHistory() { db.forEach(render); }
    </script>
</body>
                </html>
